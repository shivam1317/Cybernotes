"use strict";(self.webpackChunkcybersec_notes=self.webpackChunkcybersec_notes||[]).push([[5706],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),l=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,c=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=l(n),h=r,m=d["".concat(c,".").concat(h)]||d[h]||p[h]||i;return n?a.createElement(m,o(o({ref:t},u),{},{components:n})):a.createElement(m,o({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var l=2;l<i;l++)o[l]=n[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},56250:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return c},metadata:function(){return l},toc:function(){return u},default:function(){return d}});var a=n(87462),r=n(63366),i=(n(67294),n(3905)),o=["components"],s={sidebar_position:7,image:"https://www.cloudflare.com/img/learning/security/threats/cross-site-scripting/xss-attack.png",tags:["DOM"]},c=void 0,l={unversionedId:"portswigger/XSS/DOM-XSS",id:"portswigger/XSS/DOM-XSS",title:"DOM-XSS",description:"DOM-based cross-site scripting",source:"@site/docs/portswigger/XSS/DOM-XSS.md",sourceDirName:"portswigger/XSS",slug:"/portswigger/XSS/DOM-XSS",permalink:"/Cybernotes/docs/portswigger/XSS/DOM-XSS",tags:[{label:"DOM",permalink:"/Cybernotes/docs/tags/dom"}],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7,image:"https://www.cloudflare.com/img/learning/security/threats/cross-site-scripting/xss-attack.png",tags:["DOM"]},sidebar:"tutorialSidebar",previous:{title:"Stored XSS",permalink:"/Cybernotes/docs/portswigger/XSS/Stored-XSS"},next:{title:"DOM-XSS-With-reflected-and-Stored-Data",permalink:"/Cybernotes/docs/portswigger/XSS/DOM-XSS-With-reflected-and-Stored-Data"}},u=[{value:"DOM-based cross-site scripting",id:"dom-based-cross-site-scripting",children:[],level:2},{value:"What is DOM-based cross-site scripting?",id:"what-is-dom-based-cross-site-scripting",children:[],level:2},{value:"How to test for DOM-based cross-site scripting",id:"how-to-test-for-dom-based-cross-site-scripting",children:[{value:"Testing HTML sinks",id:"testing-html-sinks",children:[],level:3},{value:"Testing JavaScript execution sinks",id:"testing-javascript-execution-sinks",children:[],level:3}],level:2},{value:"Lab: DOM XSS in <code>document.write</code> sink using source <code>location.search</code>",id:"lab-dom-xss-in-documentwrite-sink-using-source-locationsearch",children:[],level:2},{value:"Lab: DOM XSS in <code>document.write</code> sink using source <code>location.search</code> inside a select element",id:"lab-dom-xss-in-documentwrite-sink-using-source-locationsearch-inside-a-select-element",children:[],level:2},{value:"Lab: DOM XSS in <code>innerHTML</code> sink using source <code>location.search</code>",id:"lab-dom-xss-in-innerhtml-sink-using-source-locationsearch",children:[],level:2}],p={toc:u};function d(e){var t=e.components,n=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"dom-based-cross-site-scripting"},"DOM-based cross-site scripting"),(0,i.kt)("p",null,"DOM-based XSS (also known as ",(0,i.kt)("a",{parentName:"p",href:"https://portswigger.net/web-security/cross-site-scripting/dom-based"},"DOM XSS"),") arises when an application contains some client-side JavaScript that processes data from an untrusted source in an unsafe way, usually by writing the data back to the DOM."),(0,i.kt)("p",null,"In the following example, an application uses some JavaScript to read the value from an input field and write that value to an element within the HTML:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"var search = document.getElementById('search').value;\nvar results = document.getElementById('results');\nresults.innerHTML = 'You searched for: ' + search;\n")),(0,i.kt)("p",null,"If the attacker can control the value of the input field, they can easily construct a malicious value that causes their own script to execute:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"You searched for: <img src=1 onerror='/* Bad stuff here... */'>")),(0,i.kt)("p",null,"In a typical case, the input field would be populated from part of the HTTP request, such as a URL query string parameter, allowing the attacker to deliver an attack using a malicious URL, in the same manner as reflected XSS."),(0,i.kt)("h2",{id:"what-is-dom-based-cross-site-scripting"},"What is DOM-based cross-site scripting?"),(0,i.kt)("p",null,"DOM-based XSS vulnerabilities usually arise when JavaScript takes data from an attacker-controllable source, such as the URL, and passes it to a sink that supports dynamic code execution, such as ",(0,i.kt)("inlineCode",{parentName:"p"},"eval()")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"innerHTML"),". This enables attackers to execute malicious JavaScript, which typically allows them to hijack other users' accounts."),(0,i.kt)("p",null,"To deliver a DOM-based XSS attack, you need to place data into a source so that it is propagated to a sink and causes execution of arbitrary JavaScript."),(0,i.kt)("p",null,"The most common source for DOM XSS is the URL, which is typically accessed with the ",(0,i.kt)("inlineCode",{parentName:"p"},"window.location")," object. An attacker can construct a link to send a victim to a vulnerable page with a payload in the query string and fragment portions of the URL. In certain circumstances, such as when targeting a 404 page or a website running PHP, the payload can also be placed in the path."),(0,i.kt)("p",null,"For a detailed explanation of the taint flow between sources and sinks, please refer to the ",(0,i.kt)("a",{parentName:"p",href:"https://portswigger.net/web-security/dom-based"},"DOM-based vulnerabilities")," page."),(0,i.kt)("h2",{id:"how-to-test-for-dom-based-cross-site-scripting"},"How to test for DOM-based cross-site scripting"),(0,i.kt)("p",null,"The majority of DOM XSS vulnerabilities can be found quickly and reliably using Burp Suite's ",(0,i.kt)("a",{parentName:"p",href:"https://portswigger.net/burp/vulnerability-scanner"},"web vulnerability scanner"),". To test for DOM-based cross-site scripting manually, you generally need to use a browser with developer tools, such as Chrome. You need to work through each available source in turn, and test each one individually."),(0,i.kt)("h3",{id:"testing-html-sinks"},"Testing HTML sinks"),(0,i.kt)("p",null,"To test for DOM XSS in an HTML sink, place a random alphanumeric string into the source (such as ",(0,i.kt)("inlineCode",{parentName:"p"},"location.search"),"), then use developer tools to inspect the HTML and find where your string appears. Note that the browser's \"View source\" option won't work for DOM XSS testing because it doesn't take account of changes that have been performed in the HTML by JavaScript. In Chrome's developer tools, you can use ",(0,i.kt)("inlineCode",{parentName:"p"},"Control+F")," (or ",(0,i.kt)("inlineCode",{parentName:"p"},"Command+F")," on MacOS) to search the DOM for your string."),(0,i.kt)("p",null,"For each location where your string appears within the DOM, you need to identify the context. Based on this context, you need to refine your input to see how it is processed. For example, if your string appears within a double-quoted attribute then try to inject double quotes in your string to see if you can break out of the attribute."),(0,i.kt)("p",null,"Note that browsers behave differently with regards to URL-encoding, Chrome, Firefox, and Safari will URL-encode ",(0,i.kt)("inlineCode",{parentName:"p"},"location.search")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"location.hash"),", while IE11 and Microsoft Edge (pre-Chromium) will not URL-encode these sources. If your data gets URL-encoded before being processed, then an XSS attack is unlikely to work."),(0,i.kt)("h3",{id:"testing-javascript-execution-sinks"},"Testing JavaScript execution sinks"),(0,i.kt)("p",null,"Testing JavaScript execution sinks for DOM-based XSS is a little harder. With these sinks, your input doesn't necessarily appear anywhere within the DOM, so you can't search for it. Instead you'll need to use the JavaScript debugger to determine whether and how your input is sent to a sink."),(0,i.kt)("p",null,"For each potential source, such as ",(0,i.kt)("inlineCode",{parentName:"p"},"location"),", you first need to find cases within the page's JavaScript code where the source is being referenced. In Chrome's developer tools, you can use ",(0,i.kt)("inlineCode",{parentName:"p"},"Control+Shift+F")," (or ",(0,i.kt)("inlineCode",{parentName:"p"},"Command+Alt+F")," on MacOS) to search all the page's JavaScript code for the source."),(0,i.kt)("p",null,"Once you've found where the source is being read, you can use the JavaScript debugger to add a break point and follow how the source's value is used. You might find that the source gets assigned to other variables. If this is the case, you'll need to use the search function again to track these variables and see if they're passed to a sink. When you find a sink that is being assigned data that originated from the source, you can use the debugger to inspect the value by hovering over the variable to show its value before it is sent to the sink. Then, as with HTML sinks, you need to refine your input to see if you can deliver a successful XSS attack."),(0,i.kt)("h2",{id:"lab-dom-xss-in-documentwrite-sink-using-source-locationsearch"},"Lab: DOM XSS in ",(0,i.kt)("inlineCode",{parentName:"h2"},"document.write")," sink using source ",(0,i.kt)("inlineCode",{parentName:"h2"},"location.search")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"This lab contains a ",(0,i.kt)("a",{parentName:"p",href:"https://portswigger.net/web-security/cross-site-scripting/dom-based"},"DOM-based cross-site scripting")," vulnerability in the search query tracking functionality. It uses the JavaScript ",(0,i.kt)("inlineCode",{parentName:"p"},"document.write")," function, which writes data out to the page. The ",(0,i.kt)("inlineCode",{parentName:"p"},"document.write")," function is called with data from ",(0,i.kt)("inlineCode",{parentName:"p"},"location.search"),", which you can control using the website URL.\nTo solve this lab, perform a ",(0,i.kt)("a",{parentName:"p",href:"https://portswigger.net/web-security/cross-site-scripting"},"cross-site scripting")," attack that calls the ",(0,i.kt)("inlineCode",{parentName:"p"},"alert")," function.")),(0,i.kt)("p",null,"--\x3e So i just searched for ",(0,i.kt)("inlineCode",{parentName:"p"},"test")," and intercepted the request and found this js code at the bottom of source code."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},"<script>\n  function trackSearch(query) {\n    document.write(\n      '<img src=\"/resources/images/tracker.gif?searchTerms=' + query + '\">'\n    );\n  }\n  var query = new URLSearchParams(window.location.search).get(\"search\");\n  if (query) {\n    trackSearch(query);\n  }\n<\/script>\n")),(0,i.kt)("p",null,"--\x3e So here our query is wrapper between double quotes so first we have to close that and also after that we have to close the angular bracket also. So our final payload will look like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'">\n<script>\n  alert(1);\n<\/script>\n')),(0,i.kt)("p",null,"And we solved the lab!"),(0,i.kt)("h2",{id:"lab-dom-xss-in-documentwrite-sink-using-source-locationsearch-inside-a-select-element"},"Lab: DOM XSS in ",(0,i.kt)("inlineCode",{parentName:"h2"},"document.write")," sink using source ",(0,i.kt)("inlineCode",{parentName:"h2"},"location.search")," inside a select element"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"This lab contains a ",(0,i.kt)("a",{parentName:"p",href:"https://portswigger.net/web-security/cross-site-scripting/dom-based"},"DOM-based cross-site scripting")," vulnerability in the stock checker functionality. It uses the JavaScript ",(0,i.kt)("inlineCode",{parentName:"p"},"document.write")," function, which writes data out to the page. The ",(0,i.kt)("inlineCode",{parentName:"p"},"document.write")," function is called with data from ",(0,i.kt)("inlineCode",{parentName:"p"},"location.search")," which you can control using the website URL. The data is enclosed within a select element.\nTo solve this lab, perform a ",(0,i.kt)("a",{parentName:"p",href:"https://portswigger.net/web-security/cross-site-scripting"},"cross-site scripting")," attack that breaks out of the select element and calls the ",(0,i.kt)("inlineCode",{parentName:"p"},"alert")," function.")),(0,i.kt)("p",null,"--\x3e I found this js code in check stock functionality from inspect element."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'var stores = ["London", "Paris", "Milan"];\nvar store = new URLSearchParams(window.location.search).get("storeId");\ndocument.write(\'<select name="storeId">\');\nif (store) {\n  document.write("<option selected>" + store + "</option>");\n}\nfor (var i = 0; i < stores.length; i++) {\n  if (stores[i] === store) {\n    continue;\n  }\n  document.write("<option>" + stores[i] + "</option>");\n}\ndocument.write("</select>");\n')),(0,i.kt)("p",null,"--\x3e Here the website is taking the storeId from user and writing it in the document. After that it's running a loop which will find that storeId in stores array."),(0,i.kt)("p",null,"But we can trigger alert in first write method which is"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"document.write('<select name=\"storeId\">');\n")),(0,i.kt)("p",null,"So here first we have to close the double quote and tag. And also we have to close the ",(0,i.kt)("inlineCode",{parentName:"p"},"select")," tag to trigger alert."),(0,i.kt)("p",null,"so final payload will look like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'"></select><script>alert(1)<\/script>\n')),(0,i.kt)("p",null,"It triggered the popup, but it didn't solved the lab! idk why :/"),(0,i.kt)("p",null,"So i tried the image payload which will also trigger alert on error."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'"></select><img src=x onerror=alert(1)>\n')),(0,i.kt)("p",null,"And you have to pass the payload in URL because there is no input given."),(0,i.kt)("p",null,"Final payload:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'productId=1&storeId="></select><img src=x onerror=alert(1)>\n')),(0,i.kt)("h2",{id:"lab-dom-xss-in-innerhtml-sink-using-source-locationsearch"},"Lab: DOM XSS in ",(0,i.kt)("inlineCode",{parentName:"h2"},"innerHTML")," sink using source ",(0,i.kt)("inlineCode",{parentName:"h2"},"location.search")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"This lab contains a ",(0,i.kt)("a",{parentName:"p",href:"https://portswigger.net/web-security/cross-site-scripting/dom-based"},"DOM-based cross-site scripting")," vulnerability in the search blog functionality. It uses an ",(0,i.kt)("inlineCode",{parentName:"p"},"innerHTML")," assignment, which changes the HTML contents of a ",(0,i.kt)("inlineCode",{parentName:"p"},"div")," element, using data from ",(0,i.kt)("inlineCode",{parentName:"p"},"location.search"),".\nTo solve this lab, perform a ",(0,i.kt)("a",{parentName:"p",href:"https://portswigger.net/web-security/cross-site-scripting"},"cross-site scripting")," attack that calls the ",(0,i.kt)("inlineCode",{parentName:"p"},"alert")," function.")),(0,i.kt)("p",null,"--\x3e I found this js in search functionality"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'function doSearchQuery(query) {\n  document.getElementById("searchMessage").innerHTML = query;\n}\nvar query = new URLSearchParams(window.location.search).get("search");\nif (query) {\n  doSearchQuery(query);\n}\n')),(0,i.kt)("p",null,"So here we just have to use normal image payload to trigger alert."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<img src="x" onerror="alert(1)" />\n')))}d.isMDXComponent=!0}}]);